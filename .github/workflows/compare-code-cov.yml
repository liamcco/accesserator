name: Code coverage

on:
  pull_request:

jobs:
  compare-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Compute PR coverage
        id: pr_cov
        shell: bash
        run: |
          set -euo pipefail
          go version
          if ! go test ./... -coverprofile=coverage.out >test.out 2>test.err; then
            echo "go test failed (PR). stdout:";
            cat test.out || true;
            echo "go test failed (PR). stderr:";
            cat test.err || true;
            exit 1;
          fi
          if [ ! -s coverage.out ]; then
            echo "coverage.out is missing or empty (PR)";
            ls -l coverage.out || true;
            exit 1;
          fi
          go tool cover -func=coverage.out > cover.func
          echo "cover.func tail (PR):"
          tail -n5 cover.func || true
          PR_COV=$(awk '/^total:/{gsub("%","",$3); print $3/100}' cover.func | tail -n1)
          if [ -z "$PR_COV" ]; then
            echo "PR_COV is empty";
            exit 1;
          fi
          echo "pr_cov=$PR_COV" >> "$GITHUB_OUTPUT"

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Compute main coverage
        id: main_cov
        shell: bash
        working-directory: main
        run: |
          set -euo pipefail
          if ! go test ./... -coverprofile=coverage.out >test.out 2>test.err; then
            echo "go test failed (main). stdout:";
            cat test.out || true;
            echo "go test failed (main). stderr:";
            cat test.err || true;
            exit 1;
          fi
          if [ ! -s coverage.out ]; then
            echo "coverage.out is missing or empty (main)";
            ls -l coverage.out || true;
            exit 1;
          fi
          go tool cover -func=coverage.out > cover.func
          echo "cover.func tail (main):"
          tail -n5 cover.func || true
          MAIN_COV=$(awk '/^total:/{gsub("%","",$3); print $3/100}' cover.func | tail -n1)
          if [ -z "$MAIN_COV" ]; then
            echo "MAIN_COV is empty";
            exit 1;
          fi
          echo "main_cov=$MAIN_COV" >> "$GITHUB_OUTPUT"

      - name: Compare coverage
        shell: bash
        run: |
          set -euo pipefail
          PR_COV="${{ steps.pr_cov.outputs.pr_cov }}"
          MAIN_COV="${{ steps.main_cov.outputs.main_cov }}"
          echo "PR coverage: $PR_COV"
          echo "Main coverage: $MAIN_COV"
          awk -v pr="$PR_COV" -v main="$MAIN_COV" 'BEGIN { if (pr > main) exit 0; exit 1 }'
