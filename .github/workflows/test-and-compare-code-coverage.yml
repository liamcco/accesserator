name: Run go tests (Ginko) and compare code coverage with main

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  test-pr:
    name: Test PR
    runs-on: ubuntu-latest
    outputs:
      pr_cov: ${{ steps.pr_cov.outputs.pr_cov }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Running Tests
        run: |
          go mod tidy
          make test

      - name: Compute PR coverage
        if: github.event_name == 'pull_request'
        id: pr_cov
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -s cover.out ]; then
            echo "cover.out is missing or empty (PR)";
            ls -l cover.out || true;
            exit 1;
          fi
          go tool cover -func=cover.out > cover.func
          echo "cover.func tail (PR):"
          tail -n5 cover.func || true
          PR_COV=$(awk '/^total:/{gsub("%","",$3); print $3/100}' cover.func | tail -n1)
          if [ -z "$PR_COV" ]; then
            echo "PR_COV is empty";
            exit 1;
          fi
          echo "pr_cov=$PR_COV" >> "$GITHUB_OUTPUT"
  test-main:
    name: Compute main coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      main_cov: ${{ steps.main_cov.outputs.main_cov }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: main/go.mod

      - name: Running Tests (main)
        working-directory: main
        run: |
          go mod tidy
          make test

      - name: Compute main coverage
        id: main_cov
        shell: bash
        working-directory: main
        run: |
          set -euo pipefail
          if [ ! -s cover.out ]; then
            echo "cover.out is missing or empty (main)";
            ls -l cover.out || true;
            exit 1;
          fi
          go tool cover -func=cover.out > cover.func
          echo "cover.func tail (main):"
          tail -n5 cover.func || true
          MAIN_COV=$(awk '/^total:/{gsub("%","",$3); print $3/100}' cover.func | tail -n1)
          if [ -z "$MAIN_COV" ]; then
            echo "MAIN_COV is empty";
            exit 1;
          fi
          echo "main_cov=$MAIN_COV" >> "$GITHUB_OUTPUT"
  compare-cov:
    name: Compare code coverage with main
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [test-pr, test-main]
    steps:
      - name: Compare coverage
        shell: bash
        run: |
          set -euo pipefail
          PR_COV="${{ needs.test-pr.outputs.pr_cov }}"
          MAIN_COV="${{ needs.test-main.outputs.main_cov }}"
          echo "PR coverage: $PR_COV"
          echo "Main coverage: $MAIN_COV"
          awk -v pr="$PR_COV" -v main="$MAIN_COV" 'BEGIN { if (pr >= main) exit 0; exit 1 }'
